(()=>{"use strict";var e={n:t=>{var o=t&&t.__esModule?()=>t.default:()=>t;return e.d(o,{a:o}),o},d:(t,o)=>{for(var r in o)e.o(o,r)&&!e.o(t,r)&&Object.defineProperty(t,r,{enumerable:!0,get:o[r]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)};const t=require("express");var o=e.n(t);const r=require("http");var n=e.n(r);const a=require("cors");var s=e.n(a);require("dotenv/config");const c={mongoose:{url:`${process.env.MONGO_URL}${process.env.DB_NAME}`},environment:process.env.ENVIRONMENT,port:process.env.PORT,rapidApi:{key:process.env.RAPID_API_KEY,host:process.env.RAPID_API_HOST},newsDataApi:{key:process.env.NEWS_DATA_API_KEY}},i=require("winston");var m=e.n(i);const p=m().format((e=>(e instanceof Error&&Object.assign(e,{message:e.stack}),e))),l=(m().format.combine(m().format.colorize(),m().format.timestamp(),m().format.align(),m().format.printf((e=>`${JSON.stringify(e)}`))),m().createLogger({level:"development"===c.environment?"debug":"info",format:m().format.combine(p(),"development"===c.environment?m().format.colorize():m().format.uncolorize(),m().format.prettyPrint(),m().format.splat(),m().format.json(),m().format.printf((({level:e,message:t})=>`${e}: ${"object"==typeof t?JSON.stringify(t):t}`))),transports:[new(m().transports.Console)({stderrLevels:["error","info"]})]})),y=require("moment");var d=e.n(y);const u=require("mongoose");var f=e.n(u);const v=new(f().Schema)({companyCode:{type:String,require:!0},companyName:{type:String,require:!0},price:{type:Number},changePoint:{type:Number},changePercentage:{type:Number},date:{type:String}}),k=f().model("Stocks",v),g={scheduler:{interval:"0 8,12,15,23 * * *"},stonkApiUrl:e=>`https://${c.rapidApi.host}/api/v1/markets/quote?ticker=${e}&type=STOCKS`,stonkApiHeaders:{"X-RapidAPI-Key":`${c.rapidApi.key}`,"X-RapidAPI-Host":`${c.rapidApi.host}`},companies:[{key:"GD",name:"General Dynamic"},{key:"TXT",name:"Textron"},{key:"BDRAF",name:"Bombardier"},{key:"ERF",name:"Embraer"},{key:"DUAVF",name:"Dassault Aviation"},{key:"UP",name:"Wheels Up"},{key:"EADSF",name:"Airbus"},{key:"BA",name:"Boeing"},{key:"BP",name:"BP PLC"},{key:"NTOIF",name:"Neste OYJ"},{key:"SHEL",name:"Shell PLC"},{key:"HON",name:"Honeywell "},{key:"GE",name:"General Electric"},{key:"RYCEF",name:"Rolls-Royce"},{key:"WMB",name:"Williams International"},{key:"COL",name:"Rockwell Collins"}]},h=require("node-fetch");var S=e.n(h);const A=(e,t)=>{if(200===e.meta.status&&e.body.primaryData)return e=e.body.primaryData,{companyCode:t.key,companyName:t.name,date:e.date=d()().format("L").toString(),price:parseFloat(e.lastSalePrice.replace("$","")),changePoint:parseFloat(e.netChange.replace("+","")),changePercentage:parseFloat(e.percentageChange.replace("+","").replace("%",""))}},D=async(e,t)=>{const o=await S()(e,t);return await o.json()},P=o().Router();P.route("/").get((async(e,t)=>{const o=e.query.records,r=e.query.page,n=await(async(e,t)=>{try{const o=e||10,r=t-1||0;l.info({event:"Service: New Request Stocks from DB",data:{numberOfRecords:o,currentPage:r}});const n=await k.find().skip(o*r).limit(o);return l.info({event:"Service: Stocks from DB",stocks:n}),{status:"Success",statusCode:200,count:n.length,data:n}}catch(e){l.error(e)}})(o,r);l.info({event:"Controller: Records from DB",result:n}),t.status(n.statusCode).json(n)}));const R=P,w=o().Router();w.use("/stocks",R);const b=w;f().connect(c.mongoose.url).then((()=>{console.log("MongoDB URL => ",c.mongoose.url),l.info("Connected to MongoDB")})).catch((e=>{l.error(e)}));const N=require("node-cron");var C=e.n(N);const O=g.scheduler.interval;C().schedule(O,(async()=>{l.info("Company Stocks: Scheduler Started");const e=await(async()=>d()().format("L").toString())(),t=await(async e=>{try{const t=await k.find({date:e});return t.length>0&&(l.info({event:"Service: Stocks from DB for Today",stocks:t}),!0)}catch(e){l.error(e)}})(e);if(t)l.info({event:"Scheduler: Data already added for Today. :-)",currentDate:e});else{const e=await(async()=>{try{l.info({event:"Service: Request for Company Stocks "});let{stonkApiUrl:e,stonkApiHeaders:t,companies:o}=g;const r={headers:t},n=[],a=o.map((t=>e(t.key)));for(let e in a){const t=await D(a[e],r),s=A(t,o[e]);n.push(s)}return l.info({event:`Service: All company stocks for ${d()().format("L").toString()}`,companyStocks:n}),n}catch(e){l.error(e)}})()||[];if(l.info({event:"Scheduler: Fetch company stocks",companyStocks:e}),e.length>0){const t=await(async(e=[])=>{try{e=e.filter((e=>e)),l.info({event:"Service: New company stocks",data:e});const t=await k.insertMany(e,{ordered:!1}).catch((e=>{l.error(e)}));return l.info({event:"Service: Records added in Mongo DB",companyStocks:t}),t}catch(e){11e3===e.code&&l.info("Service: Record already exists."),l.error(e)}})(e);l.info(t)}else l.info({event:"Scheduler: No company stocks found. :-)"})}}));const q=o()();q.use(s()()),setInterval((()=>{n().get("http://healthcheck-backend-888c77da0ba5.herokuapp.com/"),console.log("App is alive!")}),12e5),q.use("/aircraft",b),q.get("/",((e,t)=>{console.log("Current directory:",__dirname),t.send("Welcome to Healthcheck App!")}));const B=c.port;q.listen(B,(()=>{l.info(`App is running on port ${B}`)}))})();